name: Release

on: 
  push:
    tags:
      - 'v*' # Run on tags like v1.0.0, v1.0.1 etc.

jobs:
  build:
    runs-on: windows-latest # Use windows-latest as the primary dev environment is Windows
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.x" # Use a compatible Python version
    - name: Install dependencies
      run: | 
        python -m pip install --upgrade pip
        pip install build
    - name: Build wheel
      run: python -m build
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: dist-files
        path: dist/

  release:
    needs: build
    runs-on: windows-latest
    permissions:
      contents: write # To create a release
    steps:
    - uses: actions/checkout@v4
    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: dist-files
        path: dist/
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        draft: false
        prerelease: false
    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: dist/*.whl # Upload the generated wheel file
        asset_name: docx2shelf-${{ github.ref_name }}.whl # Name the asset appropriately
        asset_content_type: application/zip # Or application/octet-stream
    - name: Upload install.bat as Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: install.bat
        asset_name: install.bat
        asset_content_type: application/x-msdownload # Or application/octet-stream