name: Release Build
on:
  push:
    tags: ['v*']

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: windows
            executable: Docx2Shelf.exe
            artifact: docx2shelf-windows
          - os: macos-latest
            platform: macos
            executable: Docx2Shelf.app
            artifact: docx2shelf-macos
          - os: ubuntu-latest
            platform: linux
            executable: Docx2Shelf
            artifact: docx2shelf-linux

    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        architecture: 'x64'

    - name: Install system dependencies (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-tk \
          python3-pil.imagetk

    - name: Install system dependencies (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        brew install python-tk
        pip install macholib Pillow

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install nuitka>=1.8.0
        pip install pillow

    - name: Verify icon files exist
      shell: bash
      run: |
        echo "Checking for existing icon files..."
        ls -la src/docx2shelf/gui/assets/
        if [ -f "src/docx2shelf/gui/assets/icon.ico" ]; then
          echo "Windows icon.ico exists"
        fi
        if [ -f "src/docx2shelf/gui/assets/icon.png" ]; then
          echo "Linux icon.png exists"
        fi

    - name: Clean directories before build
      run: |
        python -c "
        import shutil, os, glob
        # Remove dist and build directories
        for d in ['dist', 'build']:
            if os.path.exists(d):
                shutil.rmtree(d, ignore_errors=True)
        # Clean PyInstaller cache and temp files
        for pattern in ['*.spec~', '__pycache__', '*.pyc', '.DS_Store']:
            for f in glob.glob(pattern, recursive=True):
                try:
                    if os.path.isfile(f):
                        os.remove(f)
                    elif os.path.isdir(f):
                        shutil.rmtree(f, ignore_errors=True)
                except:
                    pass
        # Force remove any existing symlinks on macOS
        if os.path.exists('dist'):
            shutil.rmtree('dist', ignore_errors=True)
        "

    - name: Build GUI executable with Nuitka (all platforms)
      run: |
        python build_nuitka.py

    # Windows-specific code signing (only for Windows)
    - name: Create self-signed certificate for code signing (Windows)
      if: matrix.os == 'windows-latest'
      shell: powershell
      run: |
        # Create a self-signed certificate for code signing
        $cert = New-SelfSignedCertificate -Type CodeSigningCert -Subject "CN=Docx2Shelf Contributors, O=Docx2Shelf, C=US" -KeyAlgorithm RSA -KeyLength 2048 -Provider "Microsoft Enhanced RSA and AES Cryptographic Provider" -KeyExportPolicy Exportable -KeyUsage DigitalSignature -CertStoreLocation Cert:\CurrentUser\My

        # Export certificate to PFX file
        $certPwd = ConvertTo-SecureString -String "TempPassword123!" -Force -AsPlainText
        $cert | Export-PfxCertificate -FilePath "codesign.pfx" -Password $certPwd

        echo "Certificate created and exported"

    - name: Sign Windows executable
      if: matrix.os == 'windows-latest'
      shell: powershell
      run: |
        # Sign the Nuitka-built executable
        $signtool = "${env:ProgramFiles(x86)}\Windows Kits\10\bin\10.0.22621.0\x64\signtool.exe"
        if (-not (Test-Path $signtool)) {
          $signtool = "${env:ProgramFiles}\Windows Kits\10\bin\10.0.22621.0\x64\signtool.exe"
        }
        if (-not (Test-Path $signtool)) {
          # Try to find signtool in any available SDK version
          $signtool = Get-ChildItem "${env:ProgramFiles(x86)}\Windows Kits\10\bin\*\x64\signtool.exe" | Sort-Object FullName -Descending | Select-Object -First 1 -ExpandProperty FullName
        }

        if (Test-Path $signtool) {
          Write-Host "Found signtool at: $signtool"
          # Sign the Nuitka executable (correct path)
          if (Test-Path "dist\gui_main.dist\Docx2Shelf.exe") {
            & $signtool sign /f codesign.pfx /p "TempPassword123!" /fd SHA256 /t http://timestamp.digicert.com /d "Docx2Shelf - Native Compiled Document Converter" /du "https://github.com/LightWraith8268/Docx2Shelf" /v "dist\gui_main.dist\Docx2Shelf.exe"
            Write-Host "Nuitka executable signed successfully"
          } else {
            Write-Host "Nuitka executable not found at dist\gui_main.dist\Docx2Shelf.exe"
            Write-Host "Listing dist directory contents:"
            Get-ChildItem -Path "dist" -Recurse
          }
        } else {
          Write-Host "SignTool not found, skipping code signing"
        }

    - name: Create portable archive (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        mkdir portable
        copy dist\gui_main.dist\Docx2Shelf.exe portable\
        7z a docx2shelf-windows-portable.zip portable\*

    - name: Create portable archive (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        mkdir -p portable/Docx2Shelf.app/Contents/MacOS
        cp dist/gui_main.dist/Docx2Shelf portable/Docx2Shelf.app/Contents/MacOS/
        chmod +x portable/Docx2Shelf.app/Contents/MacOS/Docx2Shelf
        cd portable
        zip -r ../docx2shelf-macos-portable.zip Docx2Shelf.app

    - name: Create portable archive (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        mkdir portable
        cp dist/gui_main.dist/Docx2Shelf portable/
        chmod +x portable/Docx2Shelf
        tar -czf docx2shelf-linux-portable.tar.gz -C portable Docx2Shelf

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact }}
        path: |
          dist/
          portable/
          *.zip
          *.tar.gz

  create-installers:
    needs: build
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            installer-type: nsis
            artifact-name: docx2shelf-windows
          - os: macos-latest
            installer-type: dmg
            artifact-name: docx2shelf-macos
          - os: ubuntu-latest
            installer-type: appimage
            artifact-name: docx2shelf-linux

    steps:
    - uses: actions/checkout@v4

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: ${{ matrix.artifact-name }}

    - name: Create Windows installer (NSIS)
      if: matrix.installer-type == 'nsis'
      run: |
        echo "Starting Windows installer creation..."
        choco install nsis -y

        # Extract version from tag
        $version = $env:GITHUB_REF_NAME -replace '^v', ''
        echo "Building installer for version: $version"

        # Create NSIS script with enhanced anti-malware metadata
        $nsis_script = @"
        !define APP_NAME "Docx2Shelf"
        !define APP_VERSION "$version"
        !define APP_DESCRIPTION "Legitimate Document to EPUB Converter - Not Malware"
        !define APP_PUBLISHER "Docx2Shelf Open Source Project"
        !define APP_URL "https://github.com/LightWraith8268/Docx2Shelf"
        !define APP_COPYRIGHT "Copyright (c) 2024 Docx2Shelf Contributors"
        !define APP_LICENSE "MIT License"

        Name "`${APP_NAME}"
        OutFile "Docx2Shelf-Setup.exe"
        InstallDir "`$PROGRAMFILES64\Docx2Shelf"
        RequestExecutionLevel admin

        ; Force UAC elevation and embed manifest
        !ifdef UAC_PLUGIN
            !include UAC.nsh
        !endif

        ; Enhanced version information to prevent false positives
        VIAddVersionKey "ProductName" "`${APP_NAME}"
        VIAddVersionKey "CompanyName" "`${APP_PUBLISHER}"
        VIAddVersionKey "LegalCopyright" "`${APP_COPYRIGHT}"
        VIAddVersionKey "FileDescription" "LEGITIMATE SOFTWARE: `${APP_DESCRIPTION}"
        VIAddVersionKey "FileVersion" "`${APP_VERSION}.0"
        VIAddVersionKey "ProductVersion" "`${APP_VERSION}"
        VIAddVersionKey "LegalTrademarks" "LEGITIMATE SOFTWARE: Open Source Document Converter - Not Malware"
        VIAddVersionKey "Comments" "VERIFIED SAFE: Open source DOCX to EPUB converter. Source: `${APP_URL} | NOT PACKED MALWARE"
        VIAddVersionKey "PrivateBuild" "Multi-AV Compatible Build (Avast + Avira + Others)"
        VIAddVersionKey "SpecialBuild" "HEUR/APC False Positive Mitigation Build"
        VIAddVersionKey "AssemblyVersion" "`${APP_VERSION}.0.0"
        VIAddVersionKey "InternalName" "Docx2ShelfInstaller"
        VIAddVersionKey "OriginalFilename" "Docx2Shelf-Setup.exe"
        VIProductVersion "`${APP_VERSION}.0.0"

        !include "MUI2.nsh"

        !insertmacro MUI_PAGE_WELCOME
        !insertmacro MUI_PAGE_COMPONENTS
        !insertmacro MUI_PAGE_DIRECTORY
        !insertmacro MUI_PAGE_INSTFILES

        !define MUI_FINISHPAGE_RUN "`$INSTDIR\Docx2Shelf.exe"
        !define MUI_FINISHPAGE_RUN_TEXT "Launch Docx2Shelf now"
        !insertmacro MUI_PAGE_FINISH

        !insertmacro MUI_UNPAGE_WELCOME
        !insertmacro MUI_UNPAGE_CONFIRM
        !insertmacro MUI_UNPAGE_INSTFILES
        !insertmacro MUI_UNPAGE_FINISH

        !insertmacro MUI_LANGUAGE "English"

        ComponentText "Choose which features you want to install:"

        Section "!Docx2Shelf Application" SecMain
            SectionIn RO
            SetOutPath "`$INSTDIR"

            ; Set overwrite mode to always overwrite files (for upgrades)
            SetOverwrite on

            ; Stop any running instances before overwriting files
            FindWindow `$R2 "" "Docx2Shelf"
            StrCmp `$R2 0 +3
                SendMessage `$R2 16 0 0  ; WM_CLOSE
                Sleep 1000

            File "dist\gui_main.dist\Docx2Shelf.exe"

            ; Determine registry root based on installation type
            UserInfo::GetAccountType
            Pop `$R8
            StrCmp `$R8 "Admin" WriteSystemReg

            ; User installation - write to HKCU
            WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\Docx2Shelf" "DisplayName" "Docx2Shelf - Document Converter (LEGITIMATE SOFTWARE)"
            WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\Docx2Shelf" "DisplayVersion" "`${APP_VERSION}"
            WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\Docx2Shelf" "Publisher" "`${APP_PUBLISHER}"
            WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\Docx2Shelf" "UninstallString" "`$INSTDIR\uninstall.exe"
            WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\Docx2Shelf" "InstallLocation" "`$INSTDIR"
            WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\Docx2Shelf" "URLInfoAbout" "`${APP_URL}"
            WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\Docx2Shelf" "URLUpdateInfo" "`${APP_URL}/releases"
            WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\Docx2Shelf" "HelpLink" "`${APP_URL}/wiki"
            WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\Docx2Shelf" "Comments" "Open source document converter - NOT MALWARE"
            WriteRegDWORD HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\Docx2Shelf" "NoModify" 1
            WriteRegDWORD HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\Docx2Shelf" "NoRepair" 1
            Goto RegWriteDone

            WriteSystemReg:
            ; System installation - write to HKLM
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\Docx2Shelf" "DisplayName" "Docx2Shelf - Document Converter (LEGITIMATE SOFTWARE)"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\Docx2Shelf" "DisplayVersion" "`${APP_VERSION}"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\Docx2Shelf" "Publisher" "`${APP_PUBLISHER}"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\Docx2Shelf" "UninstallString" "`$INSTDIR\uninstall.exe"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\Docx2Shelf" "InstallLocation" "`$INSTDIR"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\Docx2Shelf" "URLInfoAbout" "`${APP_URL}"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\Docx2Shelf" "URLUpdateInfo" "`${APP_URL}/releases"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\Docx2Shelf" "HelpLink" "`${APP_URL}/wiki"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\Docx2Shelf" "Comments" "Open source document converter - NOT MALWARE"
            WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\Docx2Shelf" "NoModify" 1
            WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\Docx2Shelf" "NoRepair" 1

            RegWriteDone:

            WriteUninstaller "`$INSTDIR\uninstall.exe"

            ; Restore user settings if this was an upgrade
            IfFileExists "`$TEMP\Docx2ShelfBackup\*.*" 0 +4
                CreateDirectory "`$APPDATA\Docx2Shelf"
                CreateDirectory "`$LOCALAPPDATA\Docx2Shelf"
                CopyFiles /SILENT "`$TEMP\Docx2ShelfBackup\*.*" "`$APPDATA\Docx2Shelf\"
                RMDir /r "`$TEMP\Docx2ShelfBackup"
        SectionEnd

        Section "Desktop Shortcut" SecDesktop
            CreateShortcut "`$DESKTOP\Docx2Shelf.lnk" "`$INSTDIR\Docx2Shelf.exe" "" "`$INSTDIR\Docx2Shelf.exe" 0 SW_SHOWNORMAL "" "Launch Docx2Shelf - Document to EPUB Converter"
        SectionEnd

        Section "Start Menu Shortcuts" SecStartMenu
            CreateDirectory "`$SMPROGRAMS\Docx2Shelf"
            CreateShortcut "`$SMPROGRAMS\Docx2Shelf\Docx2Shelf.lnk" "`$INSTDIR\Docx2Shelf.exe" "" "`$INSTDIR\Docx2Shelf.exe" 0 SW_SHOWNORMAL "" "Launch Docx2Shelf"
            CreateShortcut "`$SMPROGRAMS\Docx2Shelf\Uninstall Docx2Shelf.lnk" "`$INSTDIR\uninstall.exe" "" "`$INSTDIR\uninstall.exe" 0 SW_SHOWNORMAL "" "Uninstall Docx2Shelf"
        SectionEnd

        !insertmacro MUI_FUNCTION_DESCRIPTION_BEGIN
            !insertmacro MUI_DESCRIPTION_TEXT `${SecMain} "Core Docx2Shelf application files (required)"
            !insertmacro MUI_DESCRIPTION_TEXT `${SecDesktop} "Create a desktop shortcut for easy access"
            !insertmacro MUI_DESCRIPTION_TEXT `${SecStartMenu} "Add Docx2Shelf to the Start Menu"
        !insertmacro MUI_FUNCTION_DESCRIPTION_END

        Function .onInit
            ; Check if running as administrator
            UserInfo::GetAccountType
            Pop `$R9
            StrCmp `$R9 "Admin" AdminOK

            ; Not running as admin, check if we can write to Program Files
            ClearErrors
            CreateDirectory "`$PROGRAMFILES64\TempWriteTest"
            IfErrors NotAdmin
            RMDir "`$PROGRAMFILES64\TempWriteTest"
            Goto AdminOK

            NotAdmin:
                MessageBox MB_YESNO|MB_ICONEXCLAMATION "Administrator privileges are required to install to Program Files.`$\r`$\n`$\r`$\nWould you like to install to your user folder instead?`$\r`$\n`$\r`$\nYes = Install to User folder (no admin required)`$\r`$\nNo = Exit (run as administrator)" IDYES UserInstall
                MessageBox MB_OK|MB_ICONINFORMATION "Please run the installer as Administrator to install to Program Files.`$\r`$\n`$\r`$\nRight-click the installer and select 'Run as administrator'."
                Abort

            UserInstall:
                StrCpy `$INSTDIR "`$LOCALAPPDATA\Docx2Shelf"

            AdminOK:

            ; Check for existing installation
            ReadRegStr `$R0 HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\Docx2Shelf" "InstallLocation"
            StrCmp `$R0 "" CheckUserInstall

            ; Found system installation, continue with upgrade logic
            Goto ExistingInstallFound

            CheckUserInstall:
            ; Check for user installation
            ReadRegStr `$R0 HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\Docx2Shelf" "InstallLocation"
            StrCmp `$R0 "" NewInstall

            ExistingInstallFound:

            ; Found existing installation
            MessageBox MB_YESNOCANCEL|MB_ICONQUESTION "Docx2Shelf is already installed in `$R0.`$\r`$\n`$\r`$\nDo you want to upgrade to version `${APP_VERSION}?`$\r`$\n`$\r`$\nYes = Upgrade (preserves settings)`$\r`$\nNo = Install to different location`$\r`$\nCancel = Exit installer" \
                IDYES UpgradeInstall IDNO NewInstall
            Abort

            UpgradeInstall:
                ; Check if application is running and close it
                FindWindow `$R1 "" "Docx2Shelf"
                StrCmp `$R1 0 NoRunning
                MessageBox MB_YESNO|MB_ICONEXCLAMATION "Docx2Shelf is currently running.`$\r`$\n`$\r`$\nPlease close the application before continuing.`$\r`$\n`$\r`$\nDo you want the installer to close it for you?" IDNO CloseManually
                    SendMessage `$R1 16 0 0  ; WM_CLOSE
                    Sleep 2000
                    FindWindow `$R1 "" "Docx2Shelf"
                    StrCmp `$R1 0 NoRunning
                    MessageBox MB_OK|MB_ICONSTOP "Unable to close Docx2Shelf automatically.`$\r`$\nPlease close it manually and restart the installer."
                    Abort
                CloseManually:
                    MessageBox MB_OK|MB_ICONSTOP "Please close Docx2Shelf and restart the installer."
                    Abort
                NoRunning:

                ; Use existing installation directory
                StrCpy `$INSTDIR `$R0

                ; Create backup of user settings before upgrade
                CreateDirectory "`$TEMP\Docx2ShelfBackup"
                CopyFiles /SILENT "`$APPDATA\Docx2Shelf\*.*" "`$TEMP\Docx2ShelfBackup\"
                CopyFiles /SILENT "`$LOCALAPPDATA\Docx2Shelf\*.*" "`$TEMP\Docx2ShelfBackup\"

            NewInstall:
            SectionSetFlags `${SecStartMenu} `${SF_SELECTED}
        FunctionEnd

        Section "Uninstall"
            Delete "`$DESKTOP\Docx2Shelf.lnk"
            Delete "`$SMPROGRAMS\Docx2Shelf\Docx2Shelf.lnk"
            Delete "`$SMPROGRAMS\Docx2Shelf\Uninstall Docx2Shelf.lnk"
            RMDir "`$SMPROGRAMS\Docx2Shelf"

            ; Remove registry entries from both possible locations
            DeleteRegKey /ifempty HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\Docx2Shelf"
            DeleteRegKey /ifempty HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\Docx2Shelf"

            MessageBox MB_YESNO "Remove application files and settings?" IDNO SkipFiles
                RMDir /r "`$INSTDIR"
                MessageBox MB_YESNO "Also remove user settings?" IDNO SkipSettings
                    RMDir /r "`$APPDATA\Docx2Shelf"
                    RMDir /r "`$LOCALAPPDATA\Docx2Shelf"
                SkipSettings:
            SkipFiles:

            MessageBox MB_OK "Docx2Shelf uninstalled successfully."
        SectionEnd
        "@
        $nsis_script | Out-File -FilePath "installer.nsi" -Encoding ASCII

        # Find and run makensis
        $env:PATH += ";C:\ProgramData\chocolatey\lib\nsis\tools;C:\Program Files (x86)\NSIS"

        $makensis_paths = @(
            "C:\Program Files (x86)\NSIS\makensis.exe",
            "C:\ProgramData\chocolatey\lib\nsis\tools\makensis.exe",
            "makensis.exe"
        )

        $makensis_found = $false
        foreach ($path in $makensis_paths) {
            if (Test-Path $path -ErrorAction SilentlyContinue) {
                echo "Found makensis at: $path"
                & $path installer.nsi
                $makensis_found = $true
                break
            }
        }

        if (-not $makensis_found) {
            echo "ERROR: makensis.exe not found"
            exit 1
        }

        # Sign the NSIS installer with the same certificate
        if (Test-Path "codesign.pfx") {
            $signtool = "${env:ProgramFiles(x86)}\Windows Kits\10\bin\10.0.22621.0\x64\signtool.exe"
            if (-not (Test-Path $signtool)) {
                $signtool = "${env:ProgramFiles}\Windows Kits\10\bin\10.0.22621.0\x64\signtool.exe"
            }
            if (-not (Test-Path $signtool)) {
                $signtool = Get-ChildItem "${env:ProgramFiles(x86)}\Windows Kits\10\bin\*\x64\signtool.exe" | Sort-Object FullName -Descending | Select-Object -First 1 -ExpandProperty FullName
            }

            if (Test-Path $signtool) {
                Write-Host "Signing NSIS installer..."
                & $signtool sign /f codesign.pfx /p "TempPassword123!" /fd SHA256 /t http://timestamp.digicert.com /d "Docx2Shelf - Legitimate Document Converter" /du "https://github.com/LightWraith8268/Docx2Shelf" /v "Docx2Shelf-Setup.exe"
                Write-Host "NSIS installer signed successfully"
            } else {
                Write-Host "SignTool not found, skipping NSIS installer signing"
            }
        } else {
            Write-Host "Certificate not found, skipping NSIS installer signing"
        }

    - name: Create macOS DMG
      if: matrix.installer-type == 'dmg'
      run: |
        echo "Starting macOS DMG creation..."
        brew install create-dmg

        mkdir -p dmg-staging
        cp -R dist/gui_main.dist/Docx2Shelf dmg-staging/
        # Create proper .app structure for macOS
        mkdir -p dmg-staging/Docx2Shelf.app/Contents/MacOS
        mv dmg-staging/Docx2Shelf dmg-staging/Docx2Shelf.app/Contents/MacOS/

        create-dmg \
          --volname "Docx2Shelf Installer" \
          --window-pos 200 120 \
          --window-size 600 400 \
          --icon-size 100 \
          --icon "Docx2Shelf.app" 175 120 \
          --hide-extension "Docx2Shelf.app" \
          --app-drop-link 425 120 \
          "Docx2Shelf-Installer.dmg" \
          "dmg-staging/"

    - name: Create Linux AppImage
      if: matrix.installer-type == 'appimage'
      run: |
        echo "Starting Linux AppImage creation..."

        sudo apt-get update
        sudo apt-get install -y fuse libfuse2

        wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
        chmod +x appimagetool-x86_64.AppImage

        mkdir -p Docx2Shelf.AppDir/usr/bin
        mkdir -p Docx2Shelf.AppDir/usr/share/applications
        mkdir -p Docx2Shelf.AppDir/usr/share/icons/hicolor/256x256/apps

        cp dist/gui_main.dist/Docx2Shelf Docx2Shelf.AppDir/usr/bin/
        chmod +x Docx2Shelf.AppDir/usr/bin/Docx2Shelf

        cat > Docx2Shelf.AppDir/docx2shelf.desktop << EOF
        [Desktop Entry]
        Type=Application
        Name=Docx2Shelf
        Comment=Document to EPUB Converter
        Exec=Docx2Shelf
        Icon=docx2shelf
        Categories=Office;Publishing;
        EOF

        cp Docx2Shelf.AppDir/docx2shelf.desktop Docx2Shelf.AppDir/usr/share/applications/
        cp src/docx2shelf/gui/assets/icon.png Docx2Shelf.AppDir/docx2shelf.png
        cp src/docx2shelf/gui/assets/icon.png Docx2Shelf.AppDir/usr/share/icons/hicolor/256x256/apps/docx2shelf.png

        cat > Docx2Shelf.AppDir/AppRun << 'EOF'
        #!/bin/bash
        HERE="$(dirname "$(readlink -f "${0}")")"
        exec "${HERE}/usr/bin/Docx2Shelf" "$@"
        EOF
        chmod +x Docx2Shelf.AppDir/AppRun

        ./appimagetool-x86_64.AppImage Docx2Shelf.AppDir Docx2Shelf-x86_64.AppImage

    - name: Upload installer artifacts
      uses: actions/upload-artifact@v4
      with:
        name: installers-${{ matrix.installer-type }}
        path: |
          *.exe
          *.dmg
          *.AppImage

  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build, create-installers]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        merge-multiple: true

    - name: Organize release files
      run: |
        mkdir -p release-assets

        # Copy installers
        find . -name "Docx2Shelf-Setup.exe" -exec cp {} release-assets/ \;
        find . -name "Docx2Shelf-Installer.dmg" -exec cp {} release-assets/ \;
        find . -name "Docx2Shelf-x86_64.AppImage" -exec cp {} release-assets/ \;

        # Copy portable versions
        find . -name "docx2shelf-*-portable.*" -exec cp {} release-assets/ \;

        cd release-assets
        VERSION=${GITHUB_REF#refs/tags/v}

        # Rename with version tag
        if [ -f "Docx2Shelf-Setup.exe" ]; then
          mv "Docx2Shelf-Setup.exe" "Docx2Shelf-${VERSION}-Windows-Installer.exe"
        fi

        if [ -f "Docx2Shelf-Installer.dmg" ]; then
          mv "Docx2Shelf-Installer.dmg" "Docx2Shelf-${VERSION}-macOS-Installer.dmg"
        fi

        if [ -f "Docx2Shelf-x86_64.AppImage" ]; then
          mv "Docx2Shelf-x86_64.AppImage" "Docx2Shelf-${VERSION}-Linux-x86_64.AppImage"
        fi

        # Rename portable files
        for file in docx2shelf-*-portable.*; do
          if [ -f "$file" ]; then
            new_name=$(echo "$file" | sed "s/docx2shelf-/Docx2Shelf-${VERSION}-/")
            mv "$file" "$new_name"
          fi
        done

        ls -la

    - name: Generate checksums
      run: |
        cd release-assets
        sha256sum * > SHA256SUMS.txt
        md5sum * > MD5SUMS.txt

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release-assets/*
        body: |
          ## Changes

          See [CHANGELOG.md](https://github.com/LightWraith8268/Docx2Shelf/blob/main/CHANGELOG.md) for detailed changes.
        draft: false
        prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}