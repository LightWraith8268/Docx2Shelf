#!/bin/bash

# Docx2Shelf Universal Installer
# This script automatically detects your platform and runs the appropriate installer
# Supports: Windows (via Git Bash/WSL), macOS, Linux
#
# Usage:
#   ./install                    - Auto-detect platform and install
#   ./install --path "/custom"   - Install to custom location
#   ./install --help             - Show help

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to detect platform
detect_platform() {
    if [[ "$OSTYPE" == "msys" || "$OSTYPE" == "cygwin" ]]; then
        echo "windows-bash"
    elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
        echo "linux"
    elif [[ "$OSTYPE" == "darwin"* ]]; then
        echo "macos"
    elif command -v cmd.exe &> /dev/null; then
        echo "windows-wsl"
    else
        echo "unknown"
    fi
}

# Function to show help
show_help() {
    echo "Docx2Shelf Universal Installer"
    echo
    echo "This installer automatically detects your operating system and runs"
    echo "the appropriate installation process."
    echo
    echo "Usage:"
    echo "  ./install                    - Auto-detect platform and install"
    echo "  ./install --path \"/custom\"   - Install to custom location"
    echo "  ./install --help             - Show this help"
    echo
    echo "Supported platforms:"
    echo "  ü™ü Windows (Git Bash, WSL, Cygwin)"
    echo "  üêß Linux (Ubuntu, CentOS, Fedora, Arch, openSUSE)"
    echo "  üçé macOS"
    echo
    echo "The installer will:"
    echo "  ‚úÖ Install Python 3.11+ if not found"
    echo "  ‚úÖ Install docx2shelf from GitHub"
    echo "  ‚úÖ Configure PATH automatically"
    echo "  ‚úÖ Verify installation"
    echo
    echo "Press any key to continue..."
    read -n 1 -s
}

# Parse arguments
CUSTOM_PATH=""
while [[ $# -gt 0 ]]; do
    case $1 in
        --help|-h)
            show_help
            exit 0
            ;;
        --path)
            CUSTOM_PATH="$2"
            shift 2
            ;;
        *)
            echo -e "${RED}Unknown option: $1${NC}"
            echo "Use --help for usage information"
            exit 1
            ;;
    esac
done

# Main installer logic
echo "========================================"
echo "   Docx2Shelf Universal Installer"
echo "========================================"
echo

# Detect platform
PLATFORM=$(detect_platform)
echo -e "${BLUE}Detected platform: $PLATFORM${NC}"
echo

case $PLATFORM in
    "windows-bash"|"windows-wsl")
        echo -e "${YELLOW}Windows environment detected${NC}"
        echo "Checking for Windows batch installer..."

        if [[ -f "install.bat" ]]; then
            echo "Running Windows installer via cmd..."
            if [[ -n "$CUSTOM_PATH" ]]; then
                cmd.exe /c "install.bat --path \"$CUSTOM_PATH\""
            else
                cmd.exe /c "install.bat"
            fi
        else
            echo -e "${YELLOW}Windows installer not found, using Unix installer${NC}"
            # Fall through to Unix installer
            if [[ -f "install.sh" ]]; then
                if [[ -n "$CUSTOM_PATH" ]]; then
                    bash install.sh --path "$CUSTOM_PATH"
                else
                    bash install.sh
                fi
            else
                echo -e "${RED}No installer found!${NC}"
                exit 1
            fi
        fi
        ;;

    "linux"|"macos")
        echo -e "${GREEN}Unix-like environment detected${NC}"
        echo "Running Unix installer..."

        if [[ -f "install.sh" ]]; then
            if [[ -n "$CUSTOM_PATH" ]]; then
                bash install.sh --path "$CUSTOM_PATH"
            else
                bash install.sh
            fi
        else
            echo -e "${RED}Unix installer (install.sh) not found!${NC}"
            exit 1
        fi
        ;;

    "unknown")
        echo -e "${YELLOW}Unknown platform detected${NC}"
        echo "Attempting to use Unix installer as fallback..."

        if [[ -f "install.sh" ]]; then
            echo -e "${YELLOW}Note: This may not work perfectly on your platform${NC}"
            if [[ -n "$CUSTOM_PATH" ]]; then
                bash install.sh --path "$CUSTOM_PATH"
            else
                bash install.sh
            fi
        else
            echo -e "${RED}No suitable installer found!${NC}"
            echo
            echo "Manual installation required:"
            echo "1. Install Python 3.11+ from your package manager or python.org"
            echo "2. Install docx2shelf: pip install --user git+https://github.com/LightWraith8268/Docx2Shelf.git"
            echo "3. Add ~/.local/bin to your PATH"
            echo
            echo "Press any key to continue..."
            read -n 1 -s
            exit 1
        fi
        ;;
esac

echo
echo -e "${GREEN}Universal installer completed!${NC}"
echo
echo "If you have any issues, try running the platform-specific installer directly:"
echo "  Windows: install.bat"
echo "  Unix/Linux/macOS: install.sh"